# Configuration Guide

OmniNode's configuration is managed through environment variables (`.env`), a centralized `Settings` class (`src/common/config.py`), and runtime flags passed to the startup script. This page documents every configurable parameter.

---

## Environment Variables (`.env`)

Create a `.env` file in the project root. All variables are loaded via `pydantic-settings`.

### LLM Configuration

| Variable | Description | Default |
|---|---|---|
| `LLM_API_KEY` | API key for the OpenAI-compatible endpoint. Use `ollama` for local Ollama instances. | `ollama` |
| `LLM_BASE_URL` | Base URL for the LLM completion API. Must be OpenAI-compatible (`/v1/chat/completions`). | `http://localhost:11434` |
| `LLM_CONTEXT_WINDOW` | Maximum tokens for the context window. Increase for complex grid state reasoning. | `4096` |

### Model Assignments

Each tier of the agent hierarchy uses a dedicated model, allowing you to optimise cost and latency per role.

| Variable | Description | Default |
|---|---|---|
| `STRATEGIC_MODEL` | LLM for the top-level Strategic Agent (cross-zone reasoning, NL interface). | `llama3.1:latest` |
| `GUARDIAN_MODEL` | LLM for the Safety Guardian (command validation). Best with a safety-tuned model. | `llama-guard3:latest` |
| `LLM_MODEL` | Backwards-compatibility alias. | `llama3.1:latest` |

!!! tip "Model Selection"
    For the Guardian, `llama-guard3` is recommended as it is specifically fine-tuned for safety classification. Note that it outputs plain text (`safe` / `unsafe`) rather than JSON—the backend handles this automatically with a fallback text parser in `SafetyGuardian.validate_command()`.

### Infrastructure Services

| Variable | Description | Default |
|---|---|---|
| `MQTT_BROKER_HOST` | Hostname for the EMQX MQTT broker. | `localhost` |
| `MQTT_BROKER_PORT` | Port for the MQTT broker. | `1883` |
| `MQTT_CLIENT_ID` | Client ID for MQTT connections. | `mcp-agent` |
| `INFLUXDB_URL` | InfluxDB HTTP API endpoint. | `http://localhost:8086` |
| `INFLUXDB_TOKEN` | Authentication token for InfluxDB. | `mcp-dev-token` |
| `INFLUXDB_ORG` | InfluxDB organisation name. | `mcp-org` |
| `INFLUXDB_BUCKET` | InfluxDB bucket for power grid telemetry. | `power_grid` |

### MCP Registry

| Variable | Description | Default |
|---|---|---|
| `REGISTRY_HOST` | Host for the FastAPI MCP Registry server. | `localhost` |
| `REGISTRY_PORT` | Port for the MCP Registry. All tools are registered here. | `8000` |

### Monitoring

| Variable | Description | Default |
|---|---|---|
| `MONITOR_INTERVAL_SECONDS` | How frequently the monitoring loop runs (in seconds). | `5` |

---

## Runtime Flags

The main entry point `scripts/start_warroom.py` accepts the following flags:

| Flag | Description |
|---|---|
| `--real` | Sets `DEMO_MODE=0`. The system uses real LLM calls (requires a running Ollama instance) and connects to the live Pandapower simulation. |
| *(no flag)* | Sets `DEMO_MODE=1`. The system uses pre-scripted mock event streams for demoing the UI without any LLM or simulation dependencies. |

### `DEMO_MODE` Behaviour

| Mode | Grid Simulation | LLM Calls | Guardian | WebSocket Events |
|---|---|---|---|---|
| `DEMO_MODE=1` (default) | Mock IEEE 30-bus layout (static positions) | None | Pre-scripted approve/block events | Generated by `src/api/mock_stream.py` |
| `DEMO_MODE=0` (`--real`) | Live Pandapower simulation | Real API calls to Ollama | Real `llama-guard3` validation | Generated by live monitoring loop |

---

## State Management

### `grid_state.json`
The central "digital twin" storage file. Updated continuously by the `PowerGridSimulation` after each power flow analysis.

```json
{
  "timestamp": "2026-02-22T03:00:00Z",
  "buses": [
    { "id": 0, "zone": "Zone 1", "voltage_pu": 1.02, "type": "slack" }
  ],
  "lines": [
    { "id": 0, "from_bus": 0, "to_bus": 1, "loading_percent": 45.3, "status": "closed" }
  ],
  "generators": [ "..." ],
  "loads": [ "..." ]
}
```

### In-Memory Grid State (`get_state()`)
The `PowerGridSimulation.get_state()` method generates the real-time JSON payload for the War Room UI. This is the **single source of truth** for the frontend, containing:

| Key | Content |
|---|---|
| `nodes` | Bus positions, voltage p.u., zone assignment, visual status |
| `edges` | Line connections, loading %, open/closed status |
| `zone_health` | Per-zone health string (`healthy` / `warning` / `critical`) |
| `violations` | Array of current voltage, thermal, and frequency violations |

### `registry_store.json`
Managed exclusively by the FastAPI MCP Registry. Holds a list of all currently active MCP servers.

```json
{
  "servers": {
    "voltage_sensor_zone1": {
      "type": "sensor",
      "url": "http://localhost:8001/mcp",
      "status": "online",
      "last_heartbeat": "2026-02-22T03:00:05Z"
    }
  }
}
```

---

## WebSocket Endpoints

The FastAPI backend exposes four WebSocket endpoints, all defined in `src/api/websocket.py`:

| Endpoint | EventBus Topic | Direction | Purpose |
|---|---|---|---|
| `/ws/grid_state` | `grid_state` | Server → Client | Real-time topology map updates (nodes, edges, zone health, violations) |
| `/ws/agent_logs` | `agent_log` | Server → Client | Strategic Agent reasoning, tool calls, and results |
| `/ws/guardian_events` | `guardian_event` | Server → Client | Safety Guardian intercept approvals and blocks |
| `/ws/commands` | N/A | Bidirectional | Receives UI commands (NL queries, scenario triggers) and routes them |

!!! note "Timestamp Injection"
    The `EventBus.publish()` method automatically injects ISO 8601 timestamps into any `dict` message missing one. This prevents `[Invalid Date]` rendering errors in the frontend.
